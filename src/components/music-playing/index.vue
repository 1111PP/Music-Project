<!-- ğŸŸ¥ğŸŸ¥ğŸŸ¥å£°æ˜:     2024/05/11 19:55
     âŒ è¿™ä¸ªç»„ä»¶æ—¶æœ‰bugçš„ï¼Œ2så†…è¿ç»­çš„è°ƒæ•´æ’­æ”¾æ—¶é—´è¿‡ç¨‹ä¸­ï¼Œé¦–æ¬¡ä¼šç«‹å³æ»šåŠ¨åˆ°æ­Œè¯å¤„ï¼Œä½†2så†…å†æ¬¡
    è°ƒæ•´æ—¶ï¼Œæ— æ³•ç«‹å³æ»šåŠ¨åˆ°æ­Œè¯å¤„ï¼Œå› ä¸ºé¦–æ¬¡æ»šåŠ¨åå°±å¤„äºèŠ‚æµçŠ¶æ€äº†,å†æ¬¡è°ƒæ•´æ—¶é—´è¿˜æ˜¯å¤„äºèŠ‚æµï¼Œåªæœ‰2såèŠ‚æµåœæ­¢ï¼Œæ‰
    ä¼šå†æ¬¡æ»šåŠ¨åˆ°æ­Œè¯å¤„
   
    å› ä¸ºæ˜¯æ‰‹åŠ¨æ§åˆ¶æ»šåŠ¨æ¡æ¥æ¥å½¢æˆæ­Œè¯æ»šåŠ¨æ•ˆæœçš„ï¼šscrollTop = offsetTop
    æ‰€ä»¥è¿™ä¼šè§¦å‘æ»šåŠ¨äº‹ä»¶scrollï¼Œä½†æ˜¯ç”¨æˆ·è‡ªå·±ä¹Ÿè¦æ»šåŠ¨æ¥æŸ¥çœ‹æ­Œè¯ï¼Œä¹Ÿä¼šè§¦å‘æ»šåŠ¨äº‹ä»¶
    æˆ‘å®šä¹‰çš„æ»šåŠ¨äº‹ä»¶å›è°ƒä¸­åšäº†è¿™äº›æ“ä½œï¼šå…ˆæš‚åœè‡ªåŠ¨æ»šåŠ¨ï¼Œç”¨æˆ·åœæ­¢æ»šåŠ¨åï¼Œæ­¤æ—¶å¦‚æœå½“å‰å¤„äºæš‚åœçŠ¶æ€ï¼Œåˆ™2000msåå›åˆ°å½“å‰æ­Œè¯å¤„

    æš‚åœçŠ¶æ€ä¸‹è°ƒæ•´æ—¶é—´æ—¶ï¼ŒğŸ’¡ç”±äºåˆå§‹isStopOffset=falseï¼Œæ‰€ä»¥ä¼šèµ°setStatuså‡½æ•°ä¸­autoScrollå‡½æ•°å®Œæˆæ»šåŠ¨ï¼Œä½†éšå³
    å°±è§¦å‘æ»šåŠ¨äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œäºæ˜¯å®ƒåˆèµ°äº†ä¸€éæ»šåŠ¨é€»è¾‘ï¼Œè™½ç„¶æ˜¾ç¤ºä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½†å®é™…å¤šæ‰§è¡Œäº†å¾ˆå¤šæ¬¡scrollTop = offsetTopæ“ä½œ

    .....ç”±äºè¿™ä¸¤ä¸ªæ»šåŠ¨äº‹ä»¶é‡å æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šbugï¼Œä½†æ€»ä½“å¸¦æ¥çš„æ•ˆæœä¸Šï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå°±æ˜¯æ²¡åŠæ³•ç«‹å³è·³è½¬è‡³ä¿®æ”¹çš„æ­Œè¯å¤„
    æš‚æ—¶å…ˆä¸ä¿®å¤äº†ğŸ˜…
-->
<!-- æ­Œè¯æ»šåŠ¨ç»„ä»¶å®é™…ä¸Šæ˜¯éœ€è¦å®æ—¶ä¼ é€’
    1.æ’­æ”¾æ—¶é—´currTime(âœ¨ç›¸å½“äºæ‹†è§£äº†ä¸€ä¸ªv-model)å’Œæ§åˆ¶æ’­æ”¾æ—¶é—´controlCurrTimeæ“ä½œ
    2.æ­Œè¯æ•°æ®
    3.æ’­æ”¾å¼€å…³çŠ¶æ€
        è¿™æ˜¯æœ€ä¸»è¦çš„,å…¶ä»–éƒ½ä¸éœ€è¦,å› ä¸ºæ­Œæ›²audioåº”è¯¥å®šä¹‰åˆ°é¡¹ç›®å…¨å±€,ä¸åº”è¯¥åœ¨æ­¤ç»„ä»¶å®šä¹‰,æ­Œè¯çš„æ»šåŠ¨,æ˜¾ç¤ºåªéœ€è¦æ ¹æ®æ—¶é—´è°ƒæ•´,è€Œæ§åˆ¶æ­Œè¯ç›¸å½“äºå­ç»„ä»¶ä¿®æ”¹çˆ¶ç»„ä»¶æ•°æ®,äºæ˜¯éœ€è¦è‡ªå®šä¹‰äº‹ä»¶,æ­Œè¯çš„æ»šåŠ¨çŠ¶æ€ç”±æ’­æ”¾æ—¶é—´å’Œæ’­æ”¾å¼€å…³å…±åŒæ§åˆ¶
     -->
<script setup>
import { forEach } from 'lodash';
import { ref, onMounted, watch, nextTick, computed } from 'vue'
import { useRouter } from 'vue-router'
const props = defineProps({
    //æ­Œè¯æ•°æ®
    lyricData1: {
        type: Array,
        default: []
    },
    //æ’­æ”¾çŠ¶æ€
    switch: {
        type: Boolean,
        default: false
    },

    // å¼€å¯å“åº”å¼çš„æ­Œè¯ç›’å­é«˜åº¦
    responseHeight: {
        type: Number,
        default: 400
    },
    currTime: {
        type: Number,
        default: 0
    },

})
const emits = defineEmits(['playEnd', 'playPause', 'playStart', 'getCurrTime', 'nextSong', 'controlCurrTime'])

//æ’­æ”¾å™¨
const audio = ref()
//æ­Œè¯ç›’å­
const lrc = ref()
//è§†å£å±•ç¤ºéƒ¨åˆ†æ­Œè¯çš„ç›’å­
const container = ref()
//ğŸŸ¥æ—¶é—´å’Œæ­Œè¯çš„æ€»æ•°æ®
const lyricData = ref(null)
const totalTime = ref(0)
//æ­Œè¯æ‰€å é«˜åº¦å¤§å°
let lrcHeight = ref(0)
// æ­Œè¯ä¸æ’­æ”¾éŸ³ä¹æ—¶é—´åŒ¹é…ï¼Œè®¾ç½®æ ·å¼æ•ˆæœ
let currIndex = ref(0)
//å½“å‰æ’­æ”¾æ—¶é—´
let currTime = ref(0)
//æ˜¯å¦åœæ­¢æ»šåŠ¨
let isStopOffset = ref(false)
//å®¹å™¨é«˜åº¦
let containerHeight = ref(400)
//æ¯è¡Œæ­Œè¯é«˜åº¦
let liHeight = 40
// let immediateScroll = ref(false)
const delay = ref(2000)

//åˆ‡æ¢æ­Œæ›²
watch(() => props.lyricData1, (newVal) => {
    lyricData.value = props.lyricData1
    nextTick(() => {
        //å›åˆ°é¡¶éƒ¨
        container.value.scrollTop = 0
        //ç”±äºæ¯é¦–æ­Œçš„æ­Œè¯æ•°é‡ä¸åŒï¼Œæ‰€ä»¥æ­Œè¯ç›’å­çš„å°ºå¯¸ä¹Ÿä¸åŒï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦é‡æ–°è®¾ç½® æ­Œè¯å±•ç¤ºç›’å­ å’Œ æ­Œè¯ç›’å­çš„é«˜åº¦
        resizeContainerHeight()
    })
}, { immediate: true })

watch(() => props.currTime, () => {
    currTime.value = props.currTime
    // console.log(currTime.value);
    setStatus(currTime.value)
})
// ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨äº‹ä»¶
//   1.æ»šåŠ¨æ—¶ï¼Œåœæ­¢æ­Œè¯åç§»
//   2.æ»šåŠ¨åœæ­¢è¶…è¿‡3sï¼Œé‡æ–°åç§»è‡³å½“å‰æ’­æ”¾æ­Œè¯å¤„
//é˜²æŠ–å¤„ç†
let timer = null
const handleScroll = (delay) => {
    //ğŸŸ¥åœæ­¢è‡ªåŠ¨åç§»
    isStopOffset.value = true
    // è‹¥ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œç›´æ¥æ¸…é™¤
    clearTimeout(timer)
    // //å¼€å¯ä¸‹ä¸€æ¬¡
    timer = setTimeout(() => {
        autoScroll()
        // ç»§ç»­è‡ªåŠ¨åç§»
        isStopOffset.value = false
    }, delay)
}

//è®°å½•æœ€åä¸€å¥æ­Œè¯æ—¶é—´
const lastWordTime = lyricData.value[lyricData.value.length - 1].time
// æ­Œè¯åç§»é€»è¾‘
const autoScroll = () => {
    // console.log(currIndex.value);
    // ğŸŸ¥è‡ªåŠ¨æ»šåŠ¨æ­Œè¯ï¼šåç§»é‡è®¡ç®—
    let currWordTop = liHeight * (currIndex.value + 1) - (liHeight / 2)
    let offsetTop = currWordTop
    // console.log(currWordTop);
    //â—æ”¹åŠ¨:åç§»containetå³ä¾§çš„æ»šåŠ¨æ¡
    if (offsetTop < 0) return //å¦‚æœåç§»é‡å°äº0ï¼Œåˆ™ä¸åç§»
    //å®ç°åç§»  
    if (container.value) container.value.scrollTop = offsetTop
}
//è‡ªåŠ¨æ’­æ”¾æ—¶çš„å¤„ç†å‡½æ•°
const setStatus = (currTime) => {
    //å¢åŠ 0.8sæ˜¯ä¸ºäº†æå‰ä¸ºä¸‹ä¸€å¥æ­Œè¯æ·»åŠ æ ·å¼
    currTime += 0.8
    //1.å»é™¤ä¸Šä¸€ä¸ªæ ·å¼
    //2.æ·»åŠ æ–°çš„æ ·å¼
    currIndex.value = lyricData.value.findIndex(i => i.time > currTime) - 1
    // âš ï¸ç‰¹æ®Šæƒ…å†µ,æ­Œè¯è½®æ’­å®Œæ¯•ï¼Œä½†æ˜¯æ—¶é—´è¿˜æ²¡åˆ°ï¼Œå±äºç»“å°¾çš„éƒ¨åˆ†,åº”è¯¥ä¿æŒåœ¨æœ€åº•éƒ¨é‚£ä¸€å¥æ­Œè¯,æ­¤æ—¶æ»šåŠ¨è‡³æœ€åº•éƒ¨
    if (currIndex.value < 0 && currTime > lastWordTime) {
        currIndex.value = lyricData.value.length - 1
    }
    // ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ—¶ï¼Œæ­Œè¯è‡ªåŠ¨æ»šåŠ¨æš‚åœisStopOffset = false
    if (!isStopOffset.value) {
        //æ­Œè¯è‡ªåŠ¨æ»šåŠ¨
        autoScroll()
    }
}
//ç‚¹å‡»æ­Œè¯è·³è½¬æ’­æ”¾æ’­æ”¾ä½ç½®
const clickLi = (i) => {
    // console.log(i);
    let moveTagTime = i.formatTime.split(':')
    moveTagTime = +moveTagTime[0] * 60 + +moveTagTime[1]
    emits('controlCurrTime', moveTagTime)
}
/**
 * é‡æ–°è®¾ç½® æ­Œè¯å±•ç¤ºç›’å­ å’Œ æ­Œè¯ç›’å­çš„é«˜åº¦
 */
const resizeContainerHeight = () => {
    containerHeight.value = props.responseHeight
    container.value.style.height = containerHeight.value + 'px'
    //é‡æ–°è®¡ç®—å¹¶è®¾ç½®æ­Œè¯ç›’å­lrcçš„é«˜åº¦
    lrcHeight.value = lyricData.value.length * liHeight
    const totalHeight = lrcHeight.value + (containerHeight.value / 1.5)
    lrc.value.style.height = totalHeight + 'px'
}

// æ­Œè¯å±•ç¤ºç›’å­å°ºå¯¸å˜åŒ–
watch(() => props.responseHeight, () => {
    nextTick(() => {
        // é‡æ–°è®¾ç½® æ­Œè¯å±•ç¤ºç›’å­ å’Œ æ­Œè¯ç›’å­çš„é«˜åº¦
        resizeContainerHeight()
    })
}, { immediate: true })


onMounted(async () => {
    // åˆå§‹åŒ–ï¼šé‡æ–°è®¾ç½® æ­Œè¯å±•ç¤ºç›’å­ å’Œ æ­Œè¯ç›’å­çš„é«˜åº¦
    resizeContainerHeight()
})
</script>

<template>
    <audio class="lp-music-audio" src=""></audio>
    <!-- å°†éŸ³ä¹æ’­æ”¾å™¨ä¸æ˜¾ç¤ºdisplay:none -->
    <div ref="container" @scroll="handleScroll(delay)" class="lp-music-container">
        <ul ref="lrc" class="lp-music-lrc">
            <li class="lp-music-item" v-for="(i, idx) in lyricData" :key="i.index" @click="clickLi(i)">
                <div class="lp-music-words" :class="{ 'lp-music-active': i.id == currIndex }">
                    {{ i.words }}
                </div>
                <div class="lp-music-time">
                    {{ i.formatTime }}
                </div>
            </li>
        </ul>
    </div>
</template>

<style scoped lang='scss'>
.lp-music-audio {
    display: none;
}

.lp-music-active {
    font-size: 25px !important;
    color: white !important;
}

.lp-music-container {
    height: 100%;
    width: 100%;
    margin: 0px auto;
    overflow: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);

    .lp-music-lrc {
        display: flex;
        flex-flow: column;
        justify-content: center;

        .lp-music-item {
            display: flex;
            align-items: center;
            position: relative;
            list-style: none;
            height: 40px;
            line-height: 40px;
            color: #ada8a8;

            .lp-music-words {
                width: 399px;
                font-size: 18px;
                font-weight: 500;
                line-height: 1;
            }

            .lp-music-time {
                position: absolute;
                right: 0%;
                width: 50px;
                height: 15px;
                line-height: 16px;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.356);
                border-radius: 10px;
                opacity: 0;
            }

            &:hover {
                color: white;
            }

            &:hover .lp-music-time {
                opacity: 1;
            }
        }
    }
}
</style>